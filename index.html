<!DOCTYPE html>
<html lang="en">
    <head>
        <script type="importmap">
            {
              "imports": {
                "/src/core/state.js": "/src/core/state.js",
                "/src/features/constants/quests.js": "/src/features/constants/quests.js",
                "/src/features/attributes/attributes.js": "/src/features/attributes/attributes.js",
                "/src/features/quests/questSystem.js": "/src/features/quests/questSystem.js",
                "/src/features/backup/backupSystem.js": "/src/features/backup/backupSystem.js"
              }
            }
            </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<meta http-equiv="Content-Security-Policy" content="sandbox allow-same-origin allow-scripts"> -->
    <title>Diced</title>
    
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#A2BC58">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Diced RPG">
<link rel="apple-touch-icon" href="/icons/icon-152x152.png">
<link rel="stylesheet" href="src/styles/main.css">

</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Diced:RPG Companion</h1>
        </div>

        <div class="overall-rank-card">
            <div class="attribute-header">
                <div class="attribute-icon-overall"></div>
                <h3>Overall Rank</h3>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="stats">
                <p>Current Rank: <span id="overall-rank">Home Cook (Bronze)</span></p>
                <p>Total Hours: <span id="overall-hours">0</span> / <span id="overall-next-rank">220</span> for next rank</p>
            </div>
        </div>

        <div class="attributes-grid">
            <div class="attribute-card">
                <div class="attribute-header">
                    <div class="attribute-icon"></div>
                    <h3>Technique</h3>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 25%"></div>
                </div>
                <div class="stats">
                    <p>Current Rank: Home Cook</p>
                    <p>Hours: <span id="technique-hours">0</span> / <span id="technique-next-level">5</span> for Level <span id="technique-level">1</span></p>
                </div>
            </div>

            <div class="attribute-card">
                <div class="attribute-header">
                    <div class="attribute-icon"></div>
                    <h3>Ingredients</h3>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 15%"></div>
                </div>
                <div class="stats">
                    <p>Current Rank: Home Cook</p>
                    <p>Hours: <span id="ingredients-hours">0</span> / <span id="ingredients-next-level">5</span> for Level <span id="ingredients-level">1</span></p>
                </div>
            </div>

            <div class="attribute-card">
                <div class="attribute-header">
                    <div class="attribute-icon"></div>
                    <h3>Flavor</h3>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 35%"></div>
                </div>
                <div class="stats">
                    <p>Current Rank: Home Cook</p>
                    <p>Hours: <span id="flavor-hours">0</span> / <span id="flavor-next-level">5</span> for Level <span id="flavor-level">1</span></p>
                </div>
            </div>

            <div class="attribute-card">
                <div class="attribute-header">
                    <div class="attribute-icon"></div>
                    <h3>Management</h3>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 45%"></div>
                </div>
                <div class="stats">
                    <p>Current Rank: Home Cook</p>
                    <p>Hours: <span id="management-hours">0</span> / <span id="management-next-level">5</span> for Level <span id="management-level">1</span></p>
                </div>
            </div>
        </div>
        
        <!-- Quest System -->
        <div id="quest-system">
            <div class="quest-card">
                <div class="header">
                    <h3>Quest System</h3>
                    <div class="button-group">
                        <button id="view-all-quests" class="quest-button secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" class="quest-icon">
                                <path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h16v2H4v-2z"/>
                            </svg>
                            View All
                        </button>
                        <button id="random-quest" class="quest-button primary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" class="quest-icon">
                                <path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm0 2v14h14V5H5zm4.5 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm-5 5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                            </svg>
                            Random Quest
                        </button>
                    </div>
                </div>
                <div id="quest-filters" class="filter-container"></div>
                <div class="content">
                    <div id="current-quest" class="hidden">
                        <!-- Quest details will be populated here -->
                    </div>
                    <div id="quest-list" class="quest-grid">
                        <!-- Quest list will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="add-hours-card">
            <div class="attribute-header">
                <div class="attribute-icon-else">+</div>
                <h3>Add Practice Hours</h3>
            </div>
            <div class="input-section">
                <select id="attribute-select">
                    <option value="technique">Technique</option>
                    <option value="ingredients">Ingredients</option>
                    <option value="flavor">Flavor</option>
                    <option value="management">Management</option>
                </select>
                <input type="number" id="hours-input" min="0.5" step="0.5" value="1">
                <button id="add-hours-button">Add Hours</button>
                <button id="adjust-hours-button">Adjust Total</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { store } from './src/core/state.js';
        import { QUEST_DATA, QUEST_TYPE_COLORS } from './src/features/constants/quests.js';
        import { updateDisplay } from './src/features/attributes/attributes.js';
        import { questSystem } from './src/features/quests/questSystem.js';
        import { notificationSystem } from './src/features/notifications/notificationSystem.js';
        import { backupSystem } from './src/features/backup/backupSystem.js';
        import { questRolloutSystem } from './src/features/quests/questRolloutSystem.js';
            
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved state
            store.loadFromStorage();
    
            // Make QUEST_DATA and store globally available
            window.QUEST_DATA = QUEST_DATA;
            window.store = store;
            
            // Set up event listeners
            const addHoursButton = document.getElementById('add-hours-button');
            if (addHoursButton) {
                addHoursButton.addEventListener('click', handleAddHours);
            }
    
            const adjustHoursButton = document.getElementById('adjust-hours-button');
            if (adjustHoursButton) {
                adjustHoursButton.addEventListener('click', handleAdjustHours);
            }
            
            // Initialize quest system
            questSystem.initialize();
            
            // Make quest system globally available
            window.questSystem = questSystem;
    
            // Initialize backup system
            backupSystem.initialize();
    
            // Initialize quest rollout system
            setTimeout(() => {
                if (window.questRolloutSystem) {
                    window.questRolloutSystem.initialize();
                }
            }, 500); // Short delay to ensure quest system is fully initialized
            
            // Initial display update
            updateDisplay();
        });
    
        // Event handler functions
        function handleAddHours() {
            const attribute = document.getElementById('attribute-select').value;
            const hours = parseFloat(document.getElementById('hours-input').value);
            
            if (hours <= 0) {
                alert('Please enter a valid number of hours');
                return;
            }
            
            const currentState = store.getState();
            store.updateState(`attributeHours.${attribute}`, 
                (currentState.attributeHours[attribute] || 0) + hours
            );
            
            // Reset input
            document.getElementById('hours-input').value = '1';
        }
    
        function handleAdjustHours() {
            const attribute = document.getElementById('attribute-select').value;
            const currentHours = store.getState().attributeHours[attribute];
            
            const newHours = prompt(
                `Current hours for ${attribute}: ${currentHours}\nEnter new total hours:`,
                currentHours
            );
            
            if (newHours === null) return; // User cancelled
            
            const newHoursNum = parseFloat(newHours);
            if (isNaN(newHoursNum) || newHoursNum < 0) {
                alert('Please enter a valid number of hours');
                return;
            }
            
            if (confirm(`Are you sure you want to set ${attribute} to ${newHoursNum} hours?`)) {
                store.updateState(`attributeHours.${attribute}`, newHoursNum);
            }
        }
    
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
            });
        }
    
        // Check for updates
        function checkForUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(reg => {
                    if (reg) reg.update().catch(err => console.error('Error checking for updates:', err));
                });
            }
        }
    
        // Add update detection
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                // New service worker activated
                window.location.reload(); // Reload the page to get new content
            });
            
            // Check for updates when the page loads and periodically
            checkForUpdates();
            setInterval(checkForUpdates, 60 * 60 * 1000); // Check hourly
        }
    
        // Make the function available globally for the update button
        window.checkForUpdates = checkForUpdates;
    </script>
   </body>
</html>
